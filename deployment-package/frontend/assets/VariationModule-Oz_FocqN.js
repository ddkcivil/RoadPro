import{c as J,r as f,a5 as P,j as e,n as h,o as E,p as V,B as d,P as U,I as g,O as D,a6 as re,t as k,$ as le,a7 as B,m as ne,N as z,J as de,C as ce,v as W,w as K,x as I,y as u,z as X,A as c,a8 as G,D as oe,e as xe,f as me,h as he,K as N,U as ue,V as je,W as Ne,X as pe,Y as ge,Z as fe,Q as ve,k as be,a9 as ye}from"./index-CewaSTRD.js";import{f as j}from"./exportUtils-B5u6ZY-6.js";import{H as we}from"./history-DhVPXOxI.js";import{S as Ce}from"./send-2vQ7VqjI.js";import{C as De}from"./circle-check-ClQeHiCK.js";import{C as Ie}from"./clock-CdXHNXMZ.js";import{C as Se}from"./calculator-D9vHTubs.js";import{R as Oe}from"./receipt-DojscuDk.js";import{S as Te}from"./save-CV1km07e.js";import"./currencyUtils-RmnVW5tT.js";/**
 * @license lucide-react v0.460.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const qe=J("FilePen",[["path",{d:"M12.5 22H18a2 2 0 0 0 2-2V7l-5-5H6a2 2 0 0 0-2 2v9.5",key:"1couwa"}],["path",{d:"M14 2v4a2 2 0 0 0 2 2h4",key:"tnqrlb"}],["path",{d:"M13.378 15.626a1 1 0 1 0-3.004-3.004l-5.01 5.012a2 2 0 0 0-.506.854l-.837 2.87a.5.5 0 0 0 .62.62l2.87-.837a2 2 0 0 0 .854-.506z",key:"1y4qbx"}]]);/**
 * @license lucide-react v0.460.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Ae=J("FileX",[["path",{d:"M15 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V7Z",key:"1rqfz7"}],["path",{d:"M14 2v4a2 2 0 0 0 2 2h4",key:"tnqrlb"}],["path",{d:"m14.5 12.5-5 5",key:"b62r18"}],["path",{d:"m9.5 12.5 5 5",key:"1rk7el"}]]),Pe=({project:o,settings:x,onProjectUpdate:q,userRole:Y})=>{var L,Q,H,$;const[Z,S]=f.useState(!1),[O,R]=f.useState(null),[_,ee]=f.useState(""),[n,v]=f.useState({voNumber:`VO-${(((L=o.variationOrders)==null?void 0:L.length)||0)+1}`,title:"",date:new Date().toISOString().split("T")[0],reason:"",items:[]}),[r,b]=f.useState({description:"",unit:"",quantityDelta:0,rate:0,isNewItem:!1}),F=j(0,x).substring(0,j(0,x).indexOf("0")),y=o.variationOrders||[],w=f.useMemo(()=>{const s=o.boq||[],t=s.reduce((m,i)=>m+i.quantity*i.rate,0),a=s.reduce((m,i)=>m+(i.variationQuantity||0)*i.rate,0),p=t+a;return{original:t,variation:a,revised:p,percent:t>0?a/t*100:0}},[o.boq]),l=f.useMemo(()=>y.find(s=>s.id===O),[O,y]),se=()=>{if(!r.description||!r.quantityDelta)return;const s={id:`voi-${Date.now()}-${Math.random()}`,boqItemId:r.boqItemId,isNewItem:r.isNewItem||!1,description:r.description,unit:r.unit||"unit",quantityDelta:Number(r.quantityDelta),rate:Number(r.rate)};v(t=>({...t,items:[...t.items||[],s]})),b({description:"",unit:"",quantityDelta:0,rate:0,isNewItem:!1})},M=s=>{v(t=>{var a;return{...t,items:(a=t.items)==null?void 0:a.filter(p=>p.id!==s)}})},te=()=>{var a,p;if(!n.title||!((a=n.items)!=null&&a.length))return;const s=n.items.reduce((m,i)=>m+i.quantityDelta*i.rate,0),t={...n,id:`vo-${Date.now()}`,status:"Draft",totalImpact:s};q({...o,variationOrders:[...y,t]}),S(!1),v({voNumber:`VO-${(((p=o.variationOrders)==null?void 0:p.length)||0)+2}`,title:"",items:[],reason:"",date:new Date().toISOString().split("T")[0]})},T=(s,t)=>{let a=[...o.boq];const p=y.map(m=>m.id===s?(t==="Approved"&&m.items.forEach(i=>{if(i.isNewItem)a.push({id:`boq-ns-${Date.now()}-${Math.random()}`,itemNo:`NS-${a.length+1}`,description:i.description,unit:i.unit,quantity:0,variationQuantity:i.quantityDelta,revisedQuantity:i.quantityDelta,rate:i.rate,amount:i.rate*i.quantityDelta,location:"",category:ye.EXTRA_WORK,completedQuantity:0});else{const C=a.findIndex(A=>A.id===i.boqItemId);if(C!==-1){const A=a[C].variationQuantity||0;a[C].variationQuantity=A+i.quantityDelta,a[C].revisedQuantity=a[C].quantity+a[C].variationQuantity}}}),{...m,status:t}):m);q({...o,variationOrders:p,boq:a})},ae=s=>{confirm("Permanently delete this variation record?")&&(q({...o,variationOrders:y.filter(t=>t.id!==s)}),O===s&&R(null))},ie=[P.ADMIN,P.PROJECT_MANAGER].includes(Y);return e.jsxs("div",{className:"h-[calc(100vh-140px)] flex gap-3 animate-in fade-in duration-500",children:[e.jsxs(h,{className:"w-80 flex flex-col",children:[e.jsxs(E,{className:"border-b px-4 py-3",children:[e.jsx(V,{className:"text-lg font-bold",children:"Contract Variations"}),e.jsxs(d,{className:"mt-3 w-full",onClick:()=>S(!0),children:[e.jsx(U,{className:"mr-2 h-4 w-4"}),"Initialize Draft"]})]}),e.jsxs("div",{className:"flex-1 overflow-y-auto",children:[e.jsx("div",{className:"p-4",children:e.jsx(g,{placeholder:"Search variations...",value:_,onChange:s=>ee(s.target.value)})}),e.jsx("div",{children:[...y].reverse().map(s=>e.jsx("div",{children:e.jsxs(h,{className:`m-2 p-4 cursor-pointer hover:bg-muted 
                                                ${O===s.id?"border-primary bg-primary/10":""}`,onClick:()=>R(s.id),children:[e.jsxs("div",{className:"flex justify-between mb-1",children:[e.jsx(D,{variant:"outline",className:"text-xs font-bold text-primary",children:s.voNumber}),e.jsx(D,{variant:s.status==="Approved"?"default":s.status==="Rejected"?"destructive":s.status==="Submitted"?"secondary":"outline",className:"text-xs",children:s.status.toUpperCase()})]}),e.jsx("p",{className:"font-bold line-clamp-1 mb-1",children:s.title}),e.jsxs("div",{className:"flex justify-between items-center text-sm text-muted-foreground",children:[e.jsxs("span",{className:"flex items-center gap-1",children:[e.jsx(re,{className:"h-3 w-3"})," ",s.date]}),e.jsx("span",{className:`font-bold ${s.totalImpact>=0?"text-green-600":"text-red-600"}`,children:j(s.totalImpact,x)})]})]})},s.id))})]})]}),e.jsx("div",{className:"flex-1 overflow-y-auto",children:e.jsxs("div",{className:"space-y-4",children:[e.jsx(h,{children:e.jsx(k,{className:"p-6",children:e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-3 gap-6 items-center",children:[e.jsxs("div",{children:[e.jsx("p",{className:"text-xs font-bold text-muted-foreground uppercase mb-1",children:"REVISED CONTRACT TOTAL"}),e.jsx("p",{className:"text-3xl font-bold",children:j(w.revised,x)}),e.jsxs("p",{className:"text-sm text-muted-foreground",children:["Original: ",j(w.original,x)]})]}),e.jsxs("div",{children:[e.jsx("p",{className:"text-xs font-bold text-muted-foreground uppercase mb-1",children:"NET CHANGE IMPACT"}),e.jsx("p",{className:`text-3xl font-bold ${w.variation>=0?"text-green-600":"text-red-600"}`,children:j(w.variation,x)}),e.jsxs("div",{className:"flex items-center gap-2 mt-1",children:[e.jsx(le,{value:Math.min(100,Math.abs(w.percent)*5),className:"flex-1"}),e.jsxs("p",{className:"text-sm font-bold",children:[w.percent.toFixed(2),"%"]})]})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsxs(d,{variant:"outline",className:"w-full",onClick:()=>B.info("Financial History view would open here"),children:[e.jsx(we,{className:"mr-2 h-4 w-4"}),"Financial History"]}),e.jsxs(d,{variant:"outline",className:"w-full",onClick:()=>B.info("Variation S-Curve visualization would open here"),children:[e.jsx(ne,{className:"mr-2 h-4 w-4"}),"Variation S-Curve"]})]})]})})}),l?e.jsxs(h,{children:[e.jsxs(E,{className:"flex flex-row items-center justify-between p-4",children:[e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx("div",{className:"w-12 h-12 rounded-lg bg-indigo-600 text-white flex items-center justify-center",children:e.jsx(z,{className:"h-6 w-6"})}),e.jsxs("div",{children:[e.jsx(V,{className:"text-xl font-bold",children:l.title}),e.jsxs("p",{className:"text-sm text-muted-foreground",children:["REF: ",l.voNumber," â€¢ STATUS: ",e.jsx("b",{className:"uppercase",children:l.status})]})]})]}),e.jsxs("div",{className:"flex items-center gap-3",children:[l.status==="Draft"&&e.jsxs(e.Fragment,{children:[e.jsx(d,{variant:"ghost",size:"icon",onClick:()=>ae(l.id),children:e.jsx(de,{className:"h-5 w-5"})}),e.jsxs(d,{onClick:()=>T(l.id,"Submitted"),children:[e.jsx(Ce,{className:"mr-2 h-4 w-4"}),"Submit for Review"]})]}),l.status==="Submitted"&&ie&&e.jsxs(e.Fragment,{children:[e.jsxs(d,{variant:"outline",className:"text-red-500 hover:bg-red-500/10",onClick:()=>T(l.id,"Rejected"),children:[e.jsx(Ae,{className:"mr-2 h-4 w-4"}),"Reject"]}),e.jsxs(d,{onClick:()=>T(l.id,"Approved"),children:[e.jsx(De,{className:"mr-2 h-4 w-4"}),"Approve & Sync"]})]}),l.status==="Approved"&&e.jsxs(D,{children:[e.jsx(ce,{className:"mr-2 h-4 w-4"}),"APPROVED & SYNCED"]}),l.status==="Rejected"&&e.jsxs(d,{variant:"outline",onClick:()=>T(l.id,"Draft"),children:[e.jsx(qe,{className:"mr-2 h-4 w-4"}),"Revise Draft"]})]})]}),e.jsx(k,{className:"p-6",children:e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-3 gap-6",children:[e.jsxs("div",{children:[e.jsx("p",{className:"text-xs font-bold text-muted-foreground uppercase mb-2",children:"TECHNICAL JUSTIFICATION"}),e.jsx(h,{className:"p-4 bg-muted border-dashed",children:e.jsx("p",{className:"text-sm leading-relaxed",children:l.reason||"No written justification provided."})}),e.jsxs("div",{className:"mt-4",children:[e.jsx("p",{className:"text-xs font-bold text-muted-foreground uppercase mb-2",children:"AUDIT SUMMARY"}),e.jsxs("div",{className:"space-y-2",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("div",{className:"w-6 h-6 rounded-full bg-muted flex items-center justify-center text-xs font-bold",children:"PM"}),e.jsx("p",{className:"text-sm",children:"Proposed by: Site Engineering Team"})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(Ie,{className:"h-4 w-4 text-muted-foreground"}),e.jsxs("p",{className:"text-sm",children:["Created on: ",l.date]})]})]})]})]}),e.jsxs("div",{className:"md:col-span-2",children:[e.jsx("p",{className:"text-xs font-bold text-muted-foreground uppercase mb-2",children:"SCHEDULE OF AMENDMENTS"}),e.jsx(h,{children:e.jsxs(W,{children:[e.jsx(K,{children:e.jsxs(I,{children:[e.jsx(u,{children:"Work Description"}),e.jsx(u,{className:"text-right",children:"Delta Qty"}),e.jsx(u,{className:"text-right",children:"Rate"}),e.jsx(u,{className:"text-right",children:"Net Value"}),e.jsx(u,{className:"text-center"})]})}),e.jsxs(X,{children:[l.items.map(s=>e.jsxs(I,{children:[e.jsxs(c,{children:[e.jsx("p",{className:"font-bold line-clamp-1",children:s.description}),e.jsx(D,{variant:"outline",className:"text-xs mt-1",children:s.isNewItem?"NON-SCHEDULED":"BOQ LINKED"})]}),e.jsx(c,{className:"text-right",children:e.jsxs("p",{className:`font-bold ${s.quantityDelta>=0?"text-green-600":"text-red-600"}`,children:[s.quantityDelta>=0?"+":"",s.quantityDelta," ",s.unit]})}),e.jsx(c,{className:"text-right",children:j(s.rate,x)}),e.jsxs(c,{className:"text-right font-bold",children:[F,(s.quantityDelta*s.rate).toLocaleString()]}),e.jsx(c,{className:"text-center",children:e.jsx(d,{variant:"ghost",size:"icon",onClick:()=>M(s.id),children:e.jsx(G,{className:"h-4 w-4"})})})]},s.id)),e.jsxs(I,{className:"bg-gray-900 text-white",children:[e.jsx(c,{colSpan:3,className:"text-right text-white text-xs font-bold uppercase",children:"TOTAL VO IMPACT"}),e.jsx(c,{className:"text-right text-white text-base font-bold",children:j(l.totalImpact,x)}),e.jsx(c,{})]})]})]})})]})]})})]}):e.jsxs(h,{className:"p-12 text-center border-dashed",children:[e.jsx(z,{className:"mx-auto h-20 w-20 text-muted-foreground opacity-20 mb-4"}),e.jsx("h3",{className:"text-xl font-bold",children:"No Variation Selected"}),e.jsx("p",{className:"text-muted-foreground",children:"Select a record from the registry or create a new draft to begin."})]})]})}),e.jsx(oe,{open:Z,onOpenChange:S,children:e.jsxs(xe,{className:"max-w-4xl h-[90vh] flex flex-col",children:[e.jsx(me,{className:"border-b pb-4",children:e.jsxs(he,{className:"flex items-center text-xl font-bold",children:[e.jsx(Se,{className:"mr-2 h-6 w-6 text-indigo-600"}),"Draft Variation Order Worksheet"]})}),e.jsx("div",{className:"flex-1 overflow-y-auto p-6 bg-muted/40",children:e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-6",children:[e.jsxs("div",{children:[e.jsxs(h,{className:"p-4 space-y-4",children:[e.jsx("h3",{className:"text-xs font-bold text-muted-foreground uppercase",children:"CONTRACTUAL DETAILS"}),e.jsxs("div",{children:[e.jsx(N,{htmlFor:"title",children:"Amendment Title"}),e.jsx(g,{id:"title",placeholder:"e.g. KM 4-5 Add. Work",value:n.title,onChange:s=>v({...n,title:s.target.value})})]}),e.jsxs("div",{className:"grid grid-cols-2 gap-4",children:[e.jsxs("div",{children:[e.jsx(N,{htmlFor:"vo-ref",children:"VO Ref #"}),e.jsx(g,{id:"vo-ref",value:n.voNumber,disabled:!0})]}),e.jsxs("div",{children:[e.jsx(N,{htmlFor:"vo-date",children:"Date"}),e.jsx(g,{id:"vo-date",type:"date",value:n.date,onChange:s=>v({...n,date:s.target.value})})]})]}),e.jsxs("div",{children:[e.jsx(N,{htmlFor:"justification",children:"Technical Justification"}),e.jsx(ue,{id:"justification",placeholder:"Detail the technical necessity...",value:n.reason,onChange:s=>v({...n,reason:s.target.value})})]})]}),e.jsxs(h,{className:"p-4 bg-indigo-900 text-white mt-6 space-y-4",children:[e.jsx("h3",{className:"text-xs font-bold text-indigo-200 uppercase",children:"STAGING WORK ITEMS"}),e.jsxs("div",{children:[e.jsx(N,{htmlFor:"boq-component",className:"text-white",children:"Existing BOQ Component"}),e.jsxs(je,{onValueChange:s=>{const t=o.boq.find(a=>a.id===s);t&&b({boqItemId:t.id,description:t.description,unit:t.unit,rate:t.rate,isNewItem:!1})},children:[e.jsx(Ne,{id:"boq-component",className:"bg-indigo-800 text-white border-indigo-700",children:e.jsx(pe,{placeholder:"Select a BOQ item"})}),e.jsx(ge,{className:"bg-indigo-800 text-white",children:o.boq.map(s=>e.jsxs(fe,{value:s.id,children:["[",s.itemNo,"] ",s.description]},s.id))})]})]}),e.jsx(ve,{className:"bg-indigo-700"}),e.jsxs("div",{children:[e.jsx(N,{htmlFor:"new-item-description",className:"text-white",children:"OR NEW SCOPE Item Description"}),e.jsx(g,{id:"new-item-description",value:r.description,onChange:s=>b({...r,description:s.target.value,isNewItem:!0,boqItemId:void 0}),className:"bg-indigo-800 text-white border-indigo-700"})]}),e.jsxs("div",{className:"grid grid-cols-2 gap-4",children:[e.jsxs("div",{children:[e.jsx(N,{htmlFor:"qty-delta",className:"text-white",children:"Qty Delta"}),e.jsx(g,{id:"qty-delta",type:"number",value:r.quantityDelta,onChange:s=>b({...r,quantityDelta:Number(s.target.value)}),className:"bg-indigo-800 text-white border-indigo-700"})]}),e.jsxs("div",{children:[e.jsx(N,{htmlFor:"unit",className:"text-white",children:"Unit"}),e.jsx(g,{id:"unit",value:r.unit,onChange:s=>b({...r,unit:s.target.value}),className:"bg-indigo-800 text-white border-indigo-700"})]})]}),e.jsxs("div",{children:[e.jsx(N,{htmlFor:"agreed-rate",className:"text-white",children:"Agreed Rate"}),e.jsx(g,{id:"agreed-rate",type:"number",value:r.rate,onChange:s=>b({...r,rate:Number(s.target.value)}),className:"bg-indigo-800 text-white border-indigo-700"})]}),e.jsxs(d,{className:"w-full bg-secondary text-secondary-foreground hover:bg-secondary/90",onClick:se,disabled:!r.description||!r.quantityDelta,children:[e.jsx(U,{className:"mr-2 h-4 w-4"})," Stage for Review"]})]})]}),e.jsx("div",{children:e.jsxs(h,{className:"h-full flex flex-col",children:[e.jsx(E,{className:"border-b",children:e.jsxs("div",{className:"flex justify-between items-center",children:[e.jsxs("div",{children:[e.jsxs(V,{className:"flex items-center text-lg font-bold",children:[e.jsx(Oe,{className:"mr-2 h-5 w-5 text-indigo-600"})," Impact Ledger"]}),e.jsx("p",{className:"text-sm text-muted-foreground",children:"Current staged changes"})]}),e.jsxs("div",{className:"text-right",children:[e.jsx("p",{className:"text-xs font-bold text-muted-foreground uppercase",children:"TOTAL NET VALUE"}),e.jsx("p",{className:"text-3xl font-bold text-indigo-700",children:j(((Q=n.items)==null?void 0:Q.reduce((s,t)=>s+t.quantityDelta*t.rate,0))||0,x)})]})]})}),e.jsx(k,{className:"flex-1 overflow-auto p-0",children:e.jsxs(W,{children:[e.jsx(K,{children:e.jsxs(I,{children:[e.jsx(u,{children:"Description"}),e.jsx(u,{className:"text-right",children:"Delta Qty"}),e.jsx(u,{className:"text-right",children:"Rate"}),e.jsx(u,{className:"text-right",children:"Amount"}),e.jsx(u,{className:"text-center"})]})}),e.jsx(X,{children:(H=n.items)==null?void 0:H.map(s=>e.jsxs(I,{children:[e.jsxs(c,{children:[e.jsx("p",{className:"font-bold line-clamp-1",children:s.description}),e.jsx(D,{variant:"outline",className:"text-xs mt-1",children:s.isNewItem?"NON-SCHEDULED":"BOQ LINKED"})]}),e.jsx(c,{className:"text-right",children:e.jsxs("p",{className:`font-bold ${s.quantityDelta>=0?"text-green-600":"text-red-600"}`,children:[s.quantityDelta>=0?"+":"",s.quantityDelta," ",s.unit]})}),e.jsx(c,{className:"text-right",children:j(s.rate,x)}),e.jsxs(c,{className:"text-right font-bold",children:[F,(s.quantityDelta*s.rate).toLocaleString()]}),e.jsx(c,{className:"text-center",children:e.jsx(d,{variant:"ghost",size:"icon",onClick:()=>M(s.id),children:e.jsx(G,{className:"h-4 w-4"})})})]},s.id))})]})}),e.jsxs(be,{className:"p-4 border-t",children:[e.jsx(d,{variant:"outline",onClick:()=>S(!1),children:"Discard"}),e.jsxs(d,{onClick:te,disabled:!(($=n.items)!=null&&$.length)||!n.title,children:[e.jsx(Te,{className:"mr-2 h-4 w-4"})," Store Draft"]})]})]})})]})})]})})]})};export{Pe as default};
