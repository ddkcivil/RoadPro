import{r as u,j as e,n as p,o as ne,p as U,B as b,P as ze,Q as H,t as T,v as M,w as W,x,y as o,z as $,A as l,m as Ke,$ as Xe,a0 as le,a1 as ae,a2 as re,D as ie,e as ce,f as oe,h as de,a3 as De,I as w,K as P,k as xe,a4 as Be,V as Ze,W as Je,X as _e,Y as et,Z as tt}from"./index-CewaSTRD.js";import{f as v}from"./exportUtils-B5u6ZY-6.js";import{T as st,a as nt,b as Pe}from"./tabs-b2piEQ7z.js";import{C as Te}from"./checkbox-CDN6qADh.js";import{F as O}from"./file-check-HERxK4FE.js";import{R as ke}from"./receipt-DojscuDk.js";import{H as lt}from"./history-DhVPXOxI.js";import{P as me}from"./printer-DtXb5IMq.js";import{C as he}from"./circle-check-ClQeHiCK.js";import{C as at}from"./calculator-D9vHTubs.js";import{F as rt}from"./file-spreadsheet-B5YUu3jb.js";import"./currencyUtils-RmnVW5tT.js";const ft=({project:d,settings:g,onProjectUpdate:ue})=>{var Se,ve,ye,Ae,we,Ie,Ce;const[E,je]=u.useState(null),[Y,be]=u.useState(null),[Le,z]=u.useState(!1),[Oe,K]=u.useState(!1),[Ne,X]=u.useState(0),[pe,Z]=u.useState(0),[Fe,J]=u.useState(!1),[q,fe]=u.useState(new Set),[G,_]=u.useState(new Set),[f,F]=u.useState({billNumber:"",date:new Date().toISOString().split("T")[0],dateOfMeasurement:new Date().toISOString().split("T")[0],orderOfBill:(((Se=d.contractBills)==null?void 0:Se.length)||0)+1,items:[],provisionalSum:0,cpaAmount:0,liquidatedDamages:0}),[i,y]=u.useState({billNumber:"",date:new Date().toISOString().split("T")[0],periodFrom:new Date().toISOString().split("T")[0],periodTo:new Date().toISOString().split("T")[0],subcontractorId:"",items:[],grossAmount:0,retentionPercent:5}),N=v(0,g).substring(0,v(0,g).indexOf("0")),I=d.contractBills||[],k=d.subcontractorBills||[],ee=(d.measurementSheets||[]).filter(t=>t.status==="Approved"),Qe=t=>{const s=(t.items||[]).reduce((He,Ye)=>He+(Ye.currentAmount||0),0),c=Number(t.cpaAmount)||0,a=Number(t.provisionalSum)||0,n=s+c,h=n-a,j=h*.13,S=h+j+a,D=n*.05,B=n*.015,Q=n*.001,R=j*.3,A=D+B+Q+R+(Number(t.advancePaymentDeduction)||0)+(Number(t.liquidatedDamages)||0),se=S-A;return{billAmountGross:s,cpaAmount:c,billAmountWithCPA:n,billAmountWithoutPS:h,vatAmount:j,totalBillWithVat:S,retentionAmount:D,advanceIncomeTax:B,contractorDevFund:Q,deductableVat:R,totalAmountPayable:se}},L=u.useMemo(()=>Qe(f),[f]),r=u.useMemo(()=>I.find(t=>t.id===E),[E,I]),ge=t=>{const s=(t.items||[]).reduce((n,h)=>n+(h.currentAmount||0),0),c=s*(Number(t.retentionPercent)/100),a=s-c;return{grossAmount:s,retentionAmount:c,netAmount:a}},V=u.useMemo(()=>ge(i),[i]),m=u.useMemo(()=>k.find(t=>t.id===Y),[Y,k]),Re=()=>{y({billNumber:`SCB-${(k.length||0)+1}`,date:new Date().toISOString().split("T")[0],periodFrom:new Date().toISOString().split("T")[0],periodTo:new Date().toISOString().split("T")[0],subcontractorId:"",items:[],grossAmount:0,retentionPercent:5}),_(new Set),Z(0),K(!0)},Me=()=>{const t=te(i.subcontractorId||"").filter(a=>G.has(a.id)),s={};t.forEach(a=>{a.boqItemId&&(s[a.boqItemId]||(s[a.boqItemId]=[]),s[a.boqItemId].push(a))});const c=Object.keys(s).map(a=>{var Q,R;const n=d.boq.find(A=>A.id===a);if(!n)return null;const j=s[a].reduce((A,se)=>A+se.quantity,0),S=(Q=d.agencies)==null?void 0:Q.find(A=>A.id===i.subcontractorId),D=(R=S==null?void 0:S.rates)==null?void 0:R.find(A=>A.boqItemId===a),B=D?D.rate:n.rate;return{id:`sb-${Date.now()}-${a}`,boqItemId:a,itemNo:n.itemNo,description:n.description,unit:n.unit,contractQuantity:n.quantity,rate:B,previousQuantity:0,currentQuantity:j,uptoDateQuantity:j,previousAmount:0,currentAmount:j*B,uptoDateAmount:j*B}}).filter(Boolean);y(a=>({...a,items:c})),Z(1)},te=t=>d.structures?d.structures.flatMap(s=>s.components.flatMap(c=>c.workLogs||[])).filter(s=>s.subcontractorId===t):[],We=(t,s)=>{const c=(i.items||[]).map(a=>a.boqItemId===t?{...a,currentQuantity:s,uptoDateQuantity:s,currentAmount:s*a.rate,uptoDateAmount:s*a.rate}:a);y({...i,items:c})},$e=()=>{const t=ge(i),s={...i,id:`scb-${Date.now()}`,status:"Draft",grossAmount:t.grossAmount,retentionPercent:i.retentionPercent||5,netAmount:t.netAmount,items:i.items||[]};ue({...d,subcontractorBills:[...d.subcontractorBills||[],s]}),K(!1),be(s.id)},Ee=()=>{var t,s;F({billNumber:`IPC-${(((t=d.contractBills)==null?void 0:t.length)||0)+1}`,date:new Date().toISOString().split("T")[0],dateOfMeasurement:new Date().toISOString().split("T")[0],orderOfBill:(((s=d.contractBills)==null?void 0:s.length)||0)+1,items:[],provisionalSum:0,cpaAmount:0,advancePaymentDeduction:0,liquidatedDamages:0}),fe(new Set),X(0),z(!0)},qe=()=>{const t=I[I.length-1],s=ee.filter(n=>q.has(n.id)),c={};s.forEach(n=>{(n.entries||[]).forEach(h=>{h.boqItemId&&(c[h.boqItemId]=(c[h.boqItemId]||0)+h.quantity)})});const a=d.boq.map(n=>{const h=t==null?void 0:t.items.find(B=>B.boqItemId===n.id),j=(h==null?void 0:h.uptoDateQuantity)||0,S=c[n.id]||0,D=j+S;return{id:`bi-${Date.now()}-${n.id}`,boqItemId:n.id,itemNo:n.itemNo,description:n.description,unit:n.unit,contractQuantity:n.quantity,rate:n.rate,previousQuantity:j,currentQuantity:S,uptoDateQuantity:D,previousAmount:j*n.rate,currentAmount:S*n.rate,uptoDateAmount:D*n.rate}});F(n=>({...n,items:a})),X(1)},Ge=(t,s)=>{const c=(f.items||[]).map(a=>{if(a.boqItemId===t){const n=a.previousQuantity+s;return{...a,currentQuantity:s,uptoDateQuantity:n,currentAmount:s*a.rate,uptoDateAmount:n*a.rate}}return a});F({...f,items:c})},Ve=()=>{const t={...f,...L,id:`ipc-${Date.now()}`,status:"Draft",type:"IPC",location:d.location,dateOfWorkOrder:d.startDate,extendedCompletionDate:d.endDate};ue({...d,contractBills:[...I,t]}),z(!1),je(t.id)},Ue=t=>{const s=new Set(q);s.has(t)?s.delete(t):s.add(t),fe(s)},C=(t,s)=>e.jsxs("div",{className:"flex items-center space-x-2",children:[e.jsx("span",{className:"text-xs font-bold text-primary w-8",children:t}),e.jsx("span",{children:s})]});return e.jsxs("div",{className:"h-[calc(100vh-140px)] flex gap-3",children:[e.jsxs(p,{className:"w-80 flex flex-col",children:[e.jsxs(ne,{className:"border-b px-4 py-3",children:[e.jsx(U,{className:"text-lg font-bold",children:"Interim Payments"}),e.jsxs(b,{className:"mt-3 w-full",onClick:Ee,children:[e.jsx(ze,{className:"mr-2 h-4 w-4"}),"New IPC Request"]}),e.jsxs(b,{variant:"outline",className:"mt-2 w-full",onClick:Re,children:[e.jsx(O,{className:"mr-2 h-4 w-4"}),"New Subcontractor Bill"]})]}),e.jsxs("div",{className:"flex-1 overflow-y-auto",children:[e.jsx(st,{defaultValue:"main",className:"mb-2",children:e.jsxs(nt,{className:"grid w-full grid-cols-2",children:[e.jsxs(Pe,{value:"main",children:["Main Contracts (",I.length,")"]}),e.jsxs(Pe,{value:"sub",children:["Subcontractor Bills (",k.length,")"]})]})}),e.jsxs("div",{className:"px-2",children:[[...I].reverse().map(t=>e.jsx(b,{variant:"ghost",className:`w-full justify-start py-6 mb-2 ${E===t.id?"bg-accent text-accent-foreground":""}`,onClick:()=>je(t.id),children:e.jsxs("div",{className:"flex items-center space-x-3",children:[e.jsx("div",{className:"w-10 h-10 rounded-full bg-indigo-100 text-indigo-600 flex items-center justify-center",children:e.jsx(ke,{className:"h-5 w-5"})}),e.jsxs("div",{children:[e.jsx("p",{className:"font-semibold",children:t.billNumber}),e.jsxs("p",{className:"text-sm text-green-600 font-bold",children:[N,t.totalAmountPayable.toLocaleString()]})]})]})},t.id)),I.length===0&&e.jsxs("div",{className:"p-4 text-center text-muted-foreground",children:[e.jsx(lt,{className:"mx-auto h-8 w-8 opacity-40 mb-2"}),e.jsx("p",{className:"text-sm",children:"No main contracts billed yet."})]}),e.jsx(H,{className:"my-4"}),e.jsx("h3",{className:"text-sm font-bold text-muted-foreground uppercase px-2 mb-2",children:"Subcontractor Bills"}),[...k].reverse().map(t=>{var c;const s=(c=d.agencies)==null?void 0:c.find(a=>a.id===t.subcontractorId);return e.jsx(b,{variant:"ghost",className:`w-full justify-start py-6 mb-2 ${Y===t.id?"bg-accent text-accent-foreground":""}`,onClick:()=>be(t.id),children:e.jsxs("div",{className:"flex items-center space-x-3",children:[e.jsx("div",{className:"w-10 h-10 rounded-full bg-amber-100 text-amber-600 flex items-center justify-center",children:e.jsx(O,{className:"h-5 w-5"})}),e.jsxs("div",{children:[e.jsx("p",{className:"font-semibold",children:t.billNumber}),e.jsx("p",{className:"text-xs text-primary",children:(s==null?void 0:s.name)||"Unknown"}),e.jsxs("p",{className:"text-sm text-green-600 font-bold",children:[N,t.netAmount.toLocaleString()]})]})]})},t.id)}),k.length===0&&e.jsxs("div",{className:"p-4 text-center text-muted-foreground",children:[e.jsx(O,{className:"mx-auto h-8 w-8 opacity-40 mb-2"}),e.jsx("p",{className:"text-sm",children:"No subcontractor bills created yet."})]})]})]})]}),e.jsx("div",{className:"flex-1 overflow-y-auto",children:r||m?e.jsxs("div",{className:"space-y-4",children:[e.jsx(p,{children:e.jsxs(T,{className:"flex justify-between items-center p-4",children:[e.jsxs("div",{className:"flex items-center space-x-4",children:[e.jsx("div",{className:`w-14 h-14 rounded-xl flex items-center justify-center 
                                                    ${m?"bg-amber-100 text-amber-600":"bg-indigo-100 text-indigo-600"}`,children:m?e.jsx(O,{className:"h-7 w-7"}):e.jsx(ke,{className:"h-7 w-7"})}),e.jsxs("div",{children:[e.jsx("h3",{className:"text-xl font-bold",children:m?m.billNumber:r==null?void 0:r.billNumber}),e.jsx("p",{className:"text-sm text-muted-foreground",children:m?e.jsxs(e.Fragment,{children:["Subcontractor Bill • Date: ",m.date,e.jsx("br",{}),((ye=(ve=d.agencies)==null?void 0:ve.find(t=>t.id===m.subcontractorId))==null?void 0:ye.name)||"Unknown Subcontractor"]}):e.jsxs(e.Fragment,{children:["Order: ",r==null?void 0:r.orderOfBill," • Date: ",r==null?void 0:r.date]})})]})]}),e.jsxs(b,{variant:"outline",onClick:()=>J(!0),children:[e.jsx(me,{className:"mr-2 h-4 w-4"}),"Print DoR Format"]})]})}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4",children:[e.jsx(p,{className:"lg:col-span-2",children:e.jsx(T,{className:"p-0",children:e.jsxs(M,{children:[e.jsx(W,{children:e.jsxs(x,{children:[e.jsx(o,{children:"SN / Financial Description"}),e.jsxs(o,{className:"text-right",children:["Amount (",N,")"]})]})}),e.jsx($,{children:m?e.jsxs(e.Fragment,{children:[e.jsxs(x,{children:[e.jsx(l,{children:C("1","Gross Bill Amount")}),e.jsx(l,{className:"text-right",children:v(m.grossAmount,g)})]}),e.jsxs(x,{children:[e.jsx(l,{children:C("2",`Less: Retention (${m.retentionPercent||0}%)`)}),e.jsx(l,{className:"text-right",children:v(m.grossAmount*((m.retentionPercent||0)/100),g)})]}),e.jsxs(x,{className:"bg-amber-50/20",children:[e.jsx(l,{children:C("3","Net Payable Amount")}),e.jsx(l,{className:"text-right font-bold",children:v(m.netAmount,g)})]})]}):e.jsxs(e.Fragment,{children:[e.jsxs(x,{children:[e.jsx(l,{children:C("1","Gross Bill Amount (Current)")}),e.jsx(l,{className:"text-right",children:v((r==null?void 0:r.billAmountGross)||0,g)})]}),e.jsxs(x,{children:[e.jsx(l,{children:C("2","Add Price Adjustment (CPA)")}),e.jsx(l,{className:"text-right",children:v((r==null?void 0:r.cpaAmount)||0,g)})]}),e.jsxs(x,{className:"bg-indigo-50/20",children:[e.jsx(l,{children:C("3","Total Bill with CPA")}),e.jsx(l,{className:"text-right font-bold",children:v((r==null?void 0:r.billAmountWithCPA)||0,g)})]}),e.jsxs(x,{children:[e.jsx(l,{children:C("4","VAT @ 13%")}),e.jsx(l,{className:"text-right",children:v((r==null?void 0:r.vatAmount)||0,g)})]}),e.jsxs(x,{className:"bg-card text-card-foreground",children:[e.jsx(l,{className:"text-white bg-gray-900",children:C("A13","NET PAYABLE TO CONTRACTOR")}),e.jsx(l,{className:"text-right text-white bg-gray-900 text-lg font-bold",children:v((r==null?void 0:r.totalAmountPayable)||0,g)})]})]})})]})})}),e.jsxs("div",{className:"space-y-4",children:[e.jsx(p,{children:e.jsxs(T,{children:[e.jsxs(U,{className:"text-base font-semibold mb-2 flex items-center",children:[e.jsx(Ke,{className:"mr-2 h-4 w-4"})," Financial Progress"]}),e.jsxs("div",{className:"flex justify-between text-sm mb-1",children:[e.jsx("p",{className:"text-muted-foreground",children:"Vs. Total Contract"}),e.jsx("p",{className:"font-bold",children:"42%"})]}),e.jsx(Xe,{value:42})]})}),e.jsxs(le,{className:"rounded-lg",children:[m?e.jsx(O,{className:"h-4 w-4"}):e.jsx(he,{className:"h-4 w-4"}),e.jsx(ae,{children:m?"Subcontractor Bill":"IPC Verified"}),e.jsx(re,{children:m?`Subcontractor bill for ${((we=(Ae=d.agencies)==null?void 0:Ae.find(t=>t.id===m.subcontractorId))==null?void 0:we.name)||"Unknown Subcontractor"}`:`This IPC has been verified against measurement book MB-${(Ie=r==null?void 0:r.id)==null?void 0:Ie.slice(-4)}.`})]})]})]})]}):e.jsxs("div",{className:"flex flex-col items-center justify-center h-full text-muted-foreground py-20",children:[e.jsx(at,{className:"h-20 w-20 opacity-20 mb-4"}),e.jsx("p",{className:"text-lg",children:"Select a Bill record"})]})}),e.jsx(ie,{open:Le,onOpenChange:z,children:e.jsxs(ce,{className:"max-w-4xl h-[90vh] flex flex-col",children:[e.jsx(oe,{className:"border-b pb-4",children:e.jsxs(de,{className:"flex items-center text-xl font-bold",children:[e.jsx(rt,{className:"mr-2 h-6 w-6 text-indigo-600"}),"Prepare New IPC (Certificate No. ",f.orderOfBill,")"]})}),e.jsxs("div",{className:"flex-1 overflow-y-auto p-6",children:[Ne===0&&e.jsxs("div",{className:"space-y-4",children:[e.jsxs(le,{children:[e.jsx(ae,{children:"Information"}),e.jsx(re,{children:"Select approved measurement sheets to auto-map work quantities to BOQ items."})]}),e.jsx("h3",{className:"text-lg font-bold",children:"Available Measurement Sheets (Approved)"}),e.jsx(p,{children:e.jsxs(M,{children:[e.jsx(W,{children:e.jsxs(x,{children:[e.jsx(o,{className:"w-[50px]"}),e.jsx(o,{children:"MB Ref #"}),e.jsx(o,{children:"Title"}),e.jsx(o,{children:"Date"}),e.jsx(o,{children:"Entries"})]})}),e.jsxs($,{children:[ee.map(t=>e.jsxs(x,{onClick:()=>Ue(t.id),className:"cursor-pointer",children:[e.jsx(l,{children:e.jsx(Te,{checked:q.has(t.id)})}),e.jsx(l,{className:"font-bold text-indigo-700",children:t.sheetNumber}),e.jsx(l,{children:t.title||"N/A"}),e.jsx(l,{children:t.date}),e.jsxs(l,{children:[(t.entries||[]).length," items"]})]},t.id)),ee.length===0&&e.jsx(x,{children:e.jsx(l,{colSpan:5,className:"text-center py-6 text-muted-foreground",children:"No approved measurement sheets found."})})]})]})}),e.jsx("div",{className:"text-right",children:e.jsxs(b,{disabled:q.size===0,onClick:qe,children:["Generate Quantity Matrix ",e.jsx(De,{className:"ml-2 h-4 w-4"})]})})]}),Ne===1&&e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{className:"flex justify-between items-center",children:[e.jsx("h3",{className:"text-lg font-bold text-primary",children:"Review & Adjust Work Quantities"}),e.jsxs("div",{className:"flex items-center space-x-2",children:[e.jsx("p",{className:"text-sm font-bold",children:"IPC TOTAL:"}),e.jsxs("p",{className:"text-xl font-bold text-indigo-700",children:[N,L.billAmountGross.toLocaleString()]})]})]}),e.jsx(p,{children:e.jsxs(M,{children:[e.jsx(W,{children:e.jsxs(x,{children:[e.jsx(o,{className:"w-[80px]",children:"Item"}),e.jsx(o,{children:"Description"}),e.jsx(o,{children:"Unit"}),e.jsx(o,{className:"text-right",children:"Rate"}),e.jsx(o,{className:"text-right bg-slate-100",children:"Previous"}),e.jsx(o,{className:"text-right bg-indigo-50/20",children:"Current Qty"}),e.jsx(o,{className:"text-right",children:"Upto-Date"}),e.jsx(o,{className:"text-right",children:"Amount"})]})}),e.jsx($,{children:(f.items||[]).filter(t=>t.uptoDateQuantity>0||t.currentQuantity>0).map(t=>e.jsxs(x,{children:[e.jsx(l,{className:"font-bold text-xs",children:t.itemNo}),e.jsxs(l,{className:"text-xs",children:[t.description.slice(0,60),"..."]}),e.jsx(l,{children:t.unit}),e.jsx(l,{className:"text-right",children:t.rate.toLocaleString()}),e.jsx(l,{className:"text-right bg-slate-50/30",children:t.previousQuantity.toLocaleString()}),e.jsx(l,{className:"text-right bg-indigo-50/30",children:e.jsx(w,{type:"number",value:t.currentQuantity,onChange:s=>Ge(t.boqItemId,Number(s.target.value)),className:"w-[90px] text-right text-indigo-700 font-bold"})}),e.jsx(l,{className:"text-right",children:e.jsx("p",{className:`font-bold ${t.uptoDateQuantity>t.contractQuantity?"text-red-500":""}`,children:t.uptoDateQuantity.toLocaleString()})}),e.jsx(l,{className:"text-right font-bold",children:t.currentAmount.toLocaleString()})]},t.id))})]})}),e.jsxs("div",{className:"grid grid-cols-2 gap-4",children:[e.jsxs(p,{children:[e.jsx(ne,{children:e.jsx(U,{className:"text-sm font-bold text-muted-foreground",children:"IPC HEADER INFO"})}),e.jsxs(T,{className:"space-y-2",children:[e.jsxs("div",{children:[e.jsx(P,{htmlFor:"ipc-ref",children:"IPC Reference #"}),e.jsx(w,{id:"ipc-ref",value:f.billNumber,onChange:t=>F({...f,billNumber:t.target.value})})]}),e.jsxs("div",{children:[e.jsx(P,{htmlFor:"billing-date",children:"Billing Date"}),e.jsx(w,{id:"billing-date",type:"date",value:f.date,onChange:t=>F({...f,date:t.target.value})})]})]})]}),e.jsx(p,{className:"bg-indigo-900 text-white",children:e.jsxs(T,{className:"space-y-3 p-4",children:[e.jsxs("div",{className:"flex justify-between",children:[e.jsx("p",{className:"opacity-80",children:"Current Gross Work:"}),e.jsxs("p",{className:"font-bold",children:[N,L.billAmountGross.toLocaleString()]})]}),e.jsxs("div",{className:"flex justify-between",children:[e.jsx("p",{className:"opacity-80",children:"VAT (13%):"}),e.jsxs("p",{className:"font-bold",children:[N,L.vatAmount.toLocaleString()]})]}),e.jsxs("div",{className:"flex justify-between",children:[e.jsx("p",{className:"opacity-80",children:"Retention (5%):"}),e.jsxs("p",{className:"font-bold",children:["-",N,L.retentionAmount.toLocaleString()]})]}),e.jsx(H,{className:"bg-indigo-700"}),e.jsxs("div",{className:"flex justify-between pt-1",children:[e.jsx("p",{className:"text-lg font-bold",children:"NET PAYABLE:"}),e.jsxs("p",{className:"text-lg font-bold text-green-300",children:[N,L.totalAmountPayable.toLocaleString()]})]})]})})]}),e.jsxs(xe,{children:[e.jsxs(b,{variant:"outline",onClick:()=>X(0),children:[e.jsx(Be,{className:"mr-2 h-4 w-4"}),"Back to Selection"]}),e.jsxs(b,{onClick:Ve,children:[e.jsx(he,{className:"mr-2 h-4 w-4"}),"Issue Certificate Draft"]})]})]})]})]})}),e.jsx(ie,{open:Oe,onOpenChange:K,children:e.jsxs(ce,{className:"max-w-4xl h-[90vh] flex flex-col",children:[e.jsx(oe,{className:"border-b pb-4",children:e.jsxs(de,{className:"flex items-center text-xl font-bold",children:[e.jsx(O,{className:"mr-2 h-6 w-6 text-amber-600"}),"Prepare New Subcontractor Bill (Bill No. ",i.billNumber,")"]})}),e.jsxs("div",{className:"flex-1 overflow-y-auto p-6",children:[pe===0&&e.jsxs("div",{className:"space-y-4",children:[e.jsxs(le,{children:[e.jsx(ae,{children:"Information"}),e.jsx(re,{children:"Select subcontractor and time period, then choose work logs to include in the bill."})]}),e.jsxs("div",{className:"grid grid-cols-2 gap-4",children:[e.jsxs("div",{children:[e.jsx(P,{htmlFor:"bill-number",children:"Bill Number"}),e.jsx(w,{id:"bill-number",value:i.billNumber,onChange:t=>y({...i,billNumber:t.target.value})})]}),e.jsxs("div",{children:[e.jsx(P,{htmlFor:"bill-date",children:"Bill Date"}),e.jsx(w,{id:"bill-date",type:"date",value:i.date,onChange:t=>y({...i,date:t.target.value})})]})]}),e.jsxs("div",{className:"grid grid-cols-2 gap-4",children:[e.jsxs("div",{children:[e.jsx(P,{htmlFor:"period-from",children:"Period From"}),e.jsx(w,{id:"period-from",type:"date",value:i.periodFrom,onChange:t=>y({...i,periodFrom:t.target.value})})]}),e.jsxs("div",{children:[e.jsx(P,{htmlFor:"period-to",children:"Period To"}),e.jsx(w,{id:"period-to",type:"date",value:i.periodTo,onChange:t=>y({...i,periodTo:t.target.value})})]})]}),e.jsxs("div",{children:[e.jsx(P,{htmlFor:"subcontractor",children:"Subcontractor"}),e.jsxs(Ze,{value:i.subcontractorId||"",onValueChange:t=>{y({...i,subcontractorId:t}),_(new Set)},children:[e.jsx(Je,{id:"subcontractor",children:e.jsx(_e,{placeholder:"Select a subcontractor"})}),e.jsx(et,{children:(Ce=d.agencies)==null?void 0:Ce.filter(t=>t.type==="subcontractor").map(t=>e.jsxs(tt,{value:t.id,children:[t.name," (",t.trade,")"]},t.id))})]})]}),e.jsx("h3",{className:"text-lg font-bold",children:"Available Work Logs"}),e.jsx(p,{children:e.jsxs(M,{children:[e.jsx(W,{children:e.jsxs(x,{children:[e.jsx(o,{className:"w-[50px]"}),e.jsx(o,{children:"Date"}),e.jsx(o,{children:"BOQ Item"}),e.jsx(o,{children:"Component"}),e.jsx(o,{children:"Quantity"}),e.jsx(o,{children:"Unit"})]})}),e.jsxs($,{children:[te(i.subcontractorId||"").map(t=>{var a;let s="Unknown";if(d.structures){for(const n of d.structures)for(const h of n.components)if((a=h.workLogs)!=null&&a.some(j=>j.id===t.id)){n.name,s=h.name;break}}const c=d.boq.find(n=>n.id===t.boqItemId);return e.jsxs(x,{onClick:()=>{const n=new Set(G);n.has(t.id)?n.delete(t.id):n.add(t.id),_(n)},className:"cursor-pointer",children:[e.jsx(l,{children:e.jsx(Te,{checked:G.has(t.id)})}),e.jsx(l,{children:t.date}),e.jsx(l,{children:c?`[${c.itemNo}] ${c.description.substring(0,30)}...`:"N/A"}),e.jsx(l,{children:s}),e.jsx(l,{children:t.quantity}),e.jsx(l,{children:(c==null?void 0:c.unit)||"N/A"})]},t.id)}),te(i.subcontractorId||"").length===0&&e.jsx(x,{children:e.jsx(l,{colSpan:6,className:"text-center py-6 text-muted-foreground",children:"No work logs found for this subcontractor in the project."})})]})]})}),e.jsx("div",{className:"text-right",children:e.jsxs(b,{disabled:G.size===0,onClick:Me,children:["Generate Bill Items ",e.jsx(De,{className:"ml-2 h-4 w-4"})]})})]}),pe===1&&e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{className:"flex justify-between items-center",children:[e.jsx("h3",{className:"text-lg font-bold text-primary",children:"Review & Adjust Bill Quantities"}),e.jsxs("div",{className:"flex items-center space-x-2",children:[e.jsx("p",{className:"text-sm font-bold",children:"BILL TOTAL:"}),e.jsxs("p",{className:"text-xl font-bold text-amber-700",children:[N,V.grossAmount.toLocaleString()]})]})]}),e.jsx(p,{children:e.jsxs(M,{children:[e.jsx(W,{children:e.jsxs(x,{children:[e.jsx(o,{className:"w-[80px]",children:"Item"}),e.jsx(o,{children:"Description"}),e.jsx(o,{children:"Unit"}),e.jsx(o,{className:"text-right",children:"Rate"}),e.jsx(o,{className:"text-right bg-amber-50/20",children:"Current Qty"}),e.jsx(o,{className:"text-right",children:"Amount"})]})}),e.jsx($,{children:(i.items||[]).map(t=>e.jsxs(x,{children:[e.jsx(l,{className:"font-bold text-xs",children:t.itemNo}),e.jsxs(l,{className:"text-xs",children:[t.description.slice(0,60),"..."]}),e.jsx(l,{children:t.unit}),e.jsx(l,{className:"text-right",children:t.rate.toLocaleString()}),e.jsx(l,{className:"text-right bg-amber-50/20",children:e.jsx(w,{type:"number",value:t.currentQuantity,onChange:s=>We(t.boqItemId,Number(s.target.value)),className:"w-[90px] text-right text-amber-700 font-bold"})}),e.jsx(l,{className:"text-right font-bold",children:t.currentAmount.toLocaleString()})]},t.id))})]})}),e.jsxs("div",{className:"grid grid-cols-2 gap-4",children:[e.jsxs(p,{children:[e.jsx(ne,{children:e.jsx(U,{className:"text-sm font-bold text-muted-foreground",children:"BILL SETTINGS"})}),e.jsx(T,{children:e.jsxs("div",{children:[e.jsx(P,{htmlFor:"retention-percent",children:"Retention %"}),e.jsx(w,{id:"retention-percent",type:"number",value:i.retentionPercent,onChange:t=>y({...i,retentionPercent:Number(t.target.value)})})]})})]}),e.jsx(p,{className:"bg-amber-900 text-white",children:e.jsxs(T,{className:"space-y-3 p-4",children:[e.jsxs("div",{className:"flex justify-between",children:[e.jsx("p",{className:"opacity-80",children:"Gross Amount:"}),e.jsxs("p",{className:"font-bold",children:[N,V.grossAmount.toLocaleString()]})]}),e.jsxs("div",{className:"flex justify-between",children:[e.jsxs("p",{className:"opacity-80",children:["Retention (",i.retentionPercent,"%):"]}),e.jsxs("p",{className:"font-bold",children:["-",N,V.retentionAmount.toLocaleString()]})]}),e.jsx(H,{className:"bg-amber-700"}),e.jsxs("div",{className:"flex justify-between pt-1",children:[e.jsx("p",{className:"text-lg font-bold",children:"NET PAYABLE:"}),e.jsxs("p",{className:"text-lg font-bold text-green-300",children:[N,V.netAmount.toLocaleString()]})]})]})})]}),e.jsxs(xe,{children:[e.jsxs(b,{variant:"outline",onClick:()=>Z(0),children:[e.jsx(Be,{className:"mr-2 h-4 w-4"}),"Back to Selection"]}),e.jsxs(b,{onClick:$e,children:[e.jsx(he,{className:"mr-2 h-4 w-4"}),"Issue Bill Draft"]})]})]})]})]})}),e.jsx(ie,{open:Fe,onOpenChange:J,children:e.jsxs(ce,{className:"max-w-4xl h-[90vh] flex flex-col",children:[e.jsx(oe,{className:"border-b pb-4",children:e.jsxs(de,{className:"flex items-center text-xl font-bold",children:[e.jsx(me,{className:"mr-2 h-6 w-6 text-muted-foreground"}),"Interim Payment Certificate - Print Layout"]})}),e.jsx("div",{className:"flex-1 overflow-y-auto p-6 bg-slate-100",children:e.jsxs("div",{className:"bg-white p-8 mx-auto min-h-[297mm] shadow-lg",children:[e.jsx("p",{className:"text-center text-2xl font-bold mb-4",children:"DEPARTMENT OF ROADS"}),e.jsx("p",{className:"text-center text-lg uppercase mb-6",children:"Interim Payment Certificate (IPC)"}),e.jsx(H,{className:"my-6"}),e.jsxs("p",{className:"text-sm text-muted-foreground",children:["Simulation of DoR Format... Content derived from ID: ",E]})]})}),e.jsxs(xe,{children:[e.jsx(b,{variant:"outline",onClick:()=>J(!1),children:"Close"}),e.jsxs(b,{children:[e.jsx(me,{className:"mr-2 h-4 w-4"}),"Print PDF"]})]})]})})]})};export{ft as default};
