import{r as t,a5 as I,j as e,B as o,aI as X,n as D,u as _,I as v,t as K,O as N,a6 as Y,ab as R,D as k,e as z,f as Z,h as q,K as w,V as Q,W as ee,X as se,Y as ae,Z as te,a8 as le,J as ne}from"./index-CewaSTRD.js";import{W as ie}from"./wifi-gGBct8gZ.js";import{S as T}from"./sparkles-CWxKTUax.js";import{U as E}from"./upload-CcYQvXh5.js";const F=["General","Earthwork","Structures","Pavement","Safety"],xe=({project:d,onProjectUpdate:j,userRole:y})=>{const[U,u]=t.useState(!1),[a,m]=t.useState(null),[b,C]=t.useState(!1),[g,M]=t.useState(""),[x,S]=t.useState("All"),[re,G]=t.useState(navigator.onLine);t.useEffect(()=>{const s=()=>{G(navigator.onLine)};return window.addEventListener("online",s),window.addEventListener("offline",s),()=>{window.removeEventListener("online",s),window.removeEventListener("offline",s)}},[]);const A=t.useRef(null),[n,p]=t.useState({category:"General",caption:"",location:"",date:new Date().toISOString().split("T")[0]}),[P,O]=t.useState(null),[i,L]=t.useState(null);t.useEffect(()=>()=>{i&&i.startsWith("blob:")&&URL.revokeObjectURL(i)},[i]);const f=d.sitePhotos||[],V=t.useMemo(()=>f.filter(s=>(x==="All"||s.category===x)&&(s.caption.toLowerCase().includes(g.toLowerCase())||s.location.toLowerCase().includes(g.toLowerCase()))).sort((s,l)=>new Date(l.date).getTime()-new Date(s.date).getTime()),[f,x,g]),W=s=>{if(s.target.files&&s.target.files[0]){const l=s.target.files[0];O(l),L(URL.createObjectURL(l))}},B=async()=>{if(!i)return;const s=await new Promise(c=>{const h=new FileReader;h.onloadend=()=>{const r=h.result;c(r.split(",")[1])},h.readAsDataURL(P)}),l={id:`img-${Date.now()}`,url:`data:image/${P.type.split("/")[1]||"jpeg"};base64,${s}`,date:n.date,caption:n.caption||"Site Photo",location:n.location||"Not Specified",category:n.category,isAnalyzed:!1};j({...d,sitePhotos:[...f,l]}),i&&URL.revokeObjectURL(i),u(!1),O(null),L(null)},$=async s=>{var l;C(!0);try{const c="AI analysis would be performed here.",h=(l=d.sitePhotos)==null?void 0:l.map(r=>r.id===s.id?{...r,aiAnalysis:c,isAnalyzed:!0}:r);j({...d,sitePhotos:h}),(a==null?void 0:a.id)===s.id&&m(r=>r?{...r,aiAnalysis:c,isAnalyzed:!0}:null)}catch(c){console.error("Analysis failed",c),alert("Failed to analyze photo: "+c.message)}finally{C(!1)}},H=y===I.ADMIN||y===I.PROJECT_MANAGER,J=s=>{if(!H){alert("Only Admin and Project Manager can delete photos");return}confirm("Delete this site photo permanently?")&&j({...d,sitePhotos:f.filter(l=>l.id!==s)})};return e.jsxs("div",{className:"animate-in fade-in duration-500",children:[e.jsxs("div",{className:"flex justify-between mb-4 items-center",children:[e.jsxs("div",{children:[e.jsx("h1",{className:"text-2xl font-black",children:"Visual Intelligence"}),e.jsx("p",{className:"text-sm text-muted-foreground",children:"Site surveillance and AI-powered progress monitoring"})]}),e.jsxs("div",{className:"flex gap-2",children:[e.jsxs(o,{onClick:()=>u(!0),children:[e.jsx(X,{className:"w-4 h-4 mr-2"}),"Capture Update"]}),e.jsxs("div",{className:"flex items-center gap-2 px-3 py-1 rounded-full bg-green-100 text-green-800",children:[e.jsx(ie,{className:"w-4 h-4"}),e.jsx("span",{className:"text-sm font-semibold",children:"Online"})]})]})]}),e.jsx(D,{className:"p-4 mb-6",children:e.jsxs("div",{className:"flex gap-4 items-center",children:[e.jsxs("div",{className:"relative flex-1 max-w-sm",children:[e.jsx(_,{className:"absolute left-3 top-1/2 transform -translate-y-1/2 text-muted-foreground w-4 h-4"}),e.jsx(v,{placeholder:"Search captions, locations...",value:g,onChange:s=>M(s.target.value),className:"pl-10"})]}),e.jsxs("div",{className:"flex gap-2",children:[e.jsx(o,{variant:x==="All"?"default":"outline",size:"sm",onClick:()=>S("All"),children:"All"}),F.map(s=>e.jsx(o,{variant:x===s?"default":"outline",size:"sm",onClick:()=>S(s),children:s},s))]})]})}),e.jsx("div",{className:"grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-6",children:V.map(s=>e.jsxs(D,{className:"cursor-pointer transition-all hover:shadow-lg hover:-translate-y-1",onClick:()=>m(s),children:[e.jsx("div",{className:"aspect-video overflow-hidden rounded-t-lg",children:e.jsx("img",{src:s.url,alt:s.caption,className:"w-full h-full object-cover"})}),e.jsxs(K,{className:"p-4",children:[e.jsxs("div",{className:"flex justify-between items-center mb-2",children:[e.jsx(N,{variant:"outline",children:s.category}),e.jsxs("div",{className:"flex items-center gap-1 text-xs text-muted-foreground",children:[e.jsx(Y,{className:"w-3 h-3"}),s.date]})]}),e.jsx("h3",{className:"font-semibold text-sm mb-1 truncate",children:s.caption}),e.jsxs("div",{className:"flex items-center gap-1 text-xs text-muted-foreground",children:[e.jsx(R,{className:"w-3 h-3"}),s.location]}),s.isAnalyzed&&e.jsx("div",{className:"mt-3 p-2 bg-indigo-50 rounded border border-indigo-100",children:e.jsxs("div",{className:"flex items-center gap-1 text-xs text-indigo-700 font-semibold",children:[e.jsx(T,{className:"w-3 h-3"}),"AI Analyzed"]})})]})]},s.id))}),e.jsx(k,{open:U,onOpenChange:u,children:e.jsxs(z,{className:"max-w-md",children:[e.jsx(Z,{children:e.jsx(q,{children:"Record Field Observation"})}),e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{className:"h-48 border-2 border-dashed border-gray-300 rounded-lg flex items-center justify-center cursor-pointer bg-slate-50 hover:bg-slate-100 transition-colors overflow-hidden",onClick:()=>{var s;return(s=A.current)==null?void 0:s.click()},children:[i?e.jsx("img",{src:i,className:"w-full h-full object-cover"}):e.jsxs("div",{className:"text-center text-muted-foreground",children:[e.jsx(E,{className:"w-8 h-8 mx-auto mb-2"}),e.jsx("p",{className:"text-sm",children:"Select Site Image"})]}),e.jsx("input",{type:"file",ref:A,hidden:!0,accept:"image/*",onChange:W})]}),e.jsxs("div",{children:[e.jsx(w,{htmlFor:"caption",children:"Observation Caption"}),e.jsx(v,{id:"caption",value:n.caption,onChange:s=>p({...n,caption:s.target.value})})]}),e.jsxs("div",{className:"grid grid-cols-2 gap-4",children:[e.jsxs("div",{children:[e.jsx(w,{htmlFor:"location",children:"Location"}),e.jsx(v,{id:"location",value:n.location,onChange:s=>p({...n,location:s.target.value})})]}),e.jsxs("div",{children:[e.jsx(w,{htmlFor:"category",children:"Category"}),e.jsxs(Q,{value:n.category||"General",onValueChange:s=>p({...n,category:s}),children:[e.jsx(ee,{children:e.jsx(se,{})}),e.jsx(ae,{children:F.map(s=>e.jsx(te,{value:s,children:s},s))})]})]})]})]}),e.jsxs("div",{className:"flex justify-end gap-2 mt-6",children:[e.jsx(o,{variant:"outline",onClick:()=>u(!1),children:"Cancel"}),e.jsxs(o,{onClick:B,disabled:!i,children:[e.jsx(E,{className:"w-4 h-4 mr-2"}),"Save to Log"]})]})]})}),e.jsx(k,{open:!!a,onOpenChange:()=>m(null),children:e.jsx(z,{className:"max-w-6xl max-h-[80vh] p-0",children:a&&e.jsxs("div",{className:"flex h-full",children:[e.jsxs("div",{className:"flex-1 flex items-center justify-center p-6 relative",children:[e.jsx("img",{src:a.url,className:"max-w-full max-h-full object-contain rounded-lg"}),e.jsx(o,{variant:"secondary",size:"icon",className:"absolute top-4 right-4",onClick:()=>m(null),children:e.jsx(le,{className:"w-4 h-4"})})]}),e.jsxs("div",{className:"w-96 bg-white p-6 overflow-y-auto",children:[e.jsx("h2",{className:"text-xl font-bold mb-4",children:a.caption}),e.jsxs("div",{className:"flex gap-2 mb-4",children:[e.jsx(N,{children:a.category}),e.jsx(N,{variant:"outline",children:a.date})]}),e.jsxs("div",{className:"flex items-center gap-2 text-sm text-muted-foreground mb-6",children:[e.jsx(R,{className:"w-4 h-4"}),a.location]}),e.jsxs("div",{className:"border-t pt-4",children:[e.jsxs("div",{className:"flex justify-between items-center mb-3",children:[e.jsx("h3",{className:"font-semibold",children:"AI SITE AUDITOR"}),!a.isAnalyzed&&e.jsxs(o,{size:"sm",onClick:()=>$(a),disabled:b,children:[e.jsx(T,{className:"w-4 h-4 mr-2"}),b?"Processing...":"Analyze Progress"]})]}),a.isAnalyzed?e.jsx("div",{className:"p-3 bg-indigo-50 rounded border border-indigo-100",children:e.jsx("p",{className:"text-sm whitespace-pre-wrap leading-relaxed",children:a.aiAnalysis})}):e.jsx("p",{className:"text-xs text-muted-foreground italic",children:"No automated analysis generated yet."})]}),e.jsx("div",{className:"mt-6",children:e.jsxs(o,{variant:"destructive",className:"w-full",onClick:()=>{J(a.id),m(null)},children:[e.jsx(ne,{className:"w-4 h-4 mr-2"}),"Delete Record"]})})]})]})})})]})};export{xe as default};
